# Project Steps: 从 0 到 1 的路径图

> **开发原则**：MVP 优先，每个里程碑结束时都应有可演示的成果。

---

## Milestone 0: 项目基础设施 (Infrastructure)
> 目标：搭建可持续开发的工程基座，确保团队协作效率。

### Task 0.1: 项目脚手架与 Monorepo 搭建
* **描述**：使用 Turborepo 初始化 Monorepo 结构，包含 `apps/web`（前端）、`apps/api`（后端 API）、`packages/shared`（共享类型/工具）等子包。配置 TypeScript、ESLint、Prettier 统一代码风格。
* **子任务**：
    * 初始化 Turborepo + pnpm workspace
    * 配置 `apps/web`（Next.js / React + Vite）
    * 配置 `apps/api`（NestJS）
    * 配置 `packages/shared`（共享 TypeScript 类型定义）
    * 配置 ESLint + Prettier + Husky 代码规范
* **验收标准**：`pnpm dev` 一键启动前后端，`pnpm lint` 通过全部检查。

### Task 0.2: CI/CD 管线搭建
* **描述**：基于 GitHub Actions 搭建自动化构建、测试、部署流水线。
* **子任务**：
    * 配置 GitHub Actions（lint → test → build）
    * 配置 Docker 构建流程
    * 配置开发/预发布/生产三套环境
    * 集成代码质量检查工具（SonarQube 或 CodeClimate，可选）
* **验收标准**：PR 合并自动触发构建并部署到开发环境。

### Task 0.3: 用户认证系统
* **描述**：实现完整的注册/登录功能，支持邮箱密码 + OAuth（Google/GitHub）。
* **子任务**：
    * 集成 NextAuth.js 或 Clerk
    * 实现邮箱注册/登录/密码重置
    * 实现 Google OAuth 登录
    * 实现 GitHub OAuth 登录
    * 用户 Profile 基础页面
    * JWT Token 管理与刷新机制
* **验收标准**：用户可通过邮箱或 OAuth 注册登录，登录状态持久化。

### Task 0.4: 数据库 Schema 设计与初始化
* **描述**：设计核心数据表结构，包含用户、策略、回测记录、行情数据等核心实体。
* **子任务**：
    * 设计 ER 图（User、Strategy、Backtest、MarketData 等核心实体）
    * 使用 Prisma ORM 定义 Schema
    * 编写数据库迁移脚本
    * 编写 Seed 脚本（测试数据填充）
* **验收标准**：数据库可正常迁移，Seed 数据可正常写入和查询。

---

## Milestone 1: 数据管线 (Data Pipeline)
> 目标：建立可靠的历史与实时行情数据基础设施，这是回测和模拟交易的根基。

### Task 1.1: 历史行情数据采集
* **描述**：对接核心品种（BTC, ETH, XAUUSD, EURUSD 等）过去 5 年的 M1（1分钟）及 Tick 数据，写入时序数据库。
* **子任务**：
    * 调研并对接 Crypto 数据源 API（Binance/Coinbase）
    * 调研并对接 CFD 数据源 API（Oanda/Interactive Brokers）
    * 编写数据采集 Worker（定时增量拉取）
    * 编写历史数据批量导入脚本（一次性回填 5 年数据）
    * 实现数据格式标准化（统一 OHLCV 结构）
* **验收标准**：可查询任意品种最近 5 年的 M1 K线数据，数据完整率 > 99%。

### Task 1.2: 数据清洗与质量保障
* **描述**：处理行情数据中的缺失、异常跳空、重复等问题，确保回测数据质量。
* **子任务**：
    * 编写缺失数据检测脚本
    * 实现缺失数据插值逻辑（线性插值 / 前值填充）
    * 编写异常值检测（极端跳空过滤）
    * 实现数据完整性定期巡检任务
    * 生成数据质量报告
* **验收标准**：所有品种数据通过完整性检查，异常值已标记或修复。

### Task 1.3: 实时行情 WebSocket 服务
* **描述**：搭建统一的实时行情分发网关，聚合多个数据源，通过 WebSocket 推送给前端和 Forward Test 系统。
* **子任务**：
    * 搭建 WebSocket 网关服务
    * 对接 Crypto 实时行情流（Binance WebSocket）
    * 对接 CFD 实时行情流（Oanda Streaming API）
    * 实现行情数据标准化与统一格式分发
    * 实现 Redis 缓存层（最新报价快速查询）
    * 实现客户端重连与心跳机制
* **验收标准**：前端页面可实时展示 BTC、XAUUSD 等品种的报价，延迟 < 500ms。

### Task 1.4: 行情数据 API 网关
* **描述**：提供 RESTful API 供前端查询历史 K线、品种列表、行情快照等数据。
* **子任务**：
    * 实现 `GET /api/markets` — 获取支持的品种列表
    * 实现 `GET /api/markets/:symbol/candles` — 获取历史 K线（支持时间范围/周期参数）
    * 实现 `GET /api/markets/:symbol/quote` — 获取最新报价快照
    * 实现请求频率限制（Rate Limiting）
    * 编写 API 文档（Swagger/OpenAPI）
* **验收标准**：API 可正确返回各品种的历史和实时数据，响应时间 < 200ms。

---

## Milestone 2: 回测引擎集成 (Backtest Engine)
> 目标：将 QuantConnect LEAN 引擎集成为可调用的回测服务。

### Task 2.1: LEAN 引擎容器化部署
* **描述**：将 QuantConnect LEAN 引擎封装为 Docker 容器，实现独立运行与隔离。
* **子任务**：
    * 编写 LEAN 引擎 Dockerfile
    * 配置 LEAN 与本地数据源的对接（读取 TimescaleDB 中的行情数据）
    * 实现 LEAN 容器的健康检查与自动重启
    * 编写 Docker Compose 本地开发配置
    * 性能基准测试（单次回测的资源消耗与耗时）
* **验收标准**：LEAN 容器可独立启动，接收策略代码并执行回测，输出结果 JSON。

### Task 2.2: 策略 JSON → LEAN 代码编译器
* **描述**：构建前端策略逻辑 JSON（来自拖拽画布）到 LEAN 引擎可执行代码（C#/Python）的编译器。
* **子任务**：
    * 定义策略逻辑的 JSON Schema（节点类型、连线关系、参数配置）
    * 实现 JSON → Python 策略代码生成器
    * 实现常用指标（MACD、RSI、EMA、Bollinger）的代码模板
    * 实现仓位管理逻辑的代码生成（止损/止盈/仓位比例）
    * 编写编译器的单元测试（覆盖各种策略组合）
    * 实现代码安全沙箱检查（防止恶意代码注入）
* **验收标准**：前端构建的策略 JSON 可被正确编译为 LEAN Python 代码并成功执行回测。

### Task 2.3: 回测任务队列与调度
* **描述**：实现异步回测任务系统，支持多用户并发提交回测请求。
* **子任务**：
    * 搭建 BullMQ 任务队列（基于 Redis）
    * 实现回测任务提交 API（`POST /api/backtest`）
    * 实现回测 Worker（从队列取任务 → 调用 LEAN → 写入结果）
    * 实现回测进度推送（WebSocket 推送进度百分比到前端）
    * 实现回测任务超时与失败重试机制
    * 实现并发控制（限制单用户同时运行的回测数量）
* **验收标准**：用户提交回测后可实时看到进度，回测完成后结果自动写入数据库。

### Task 2.4: 回测结果数据结构与存储
* **描述**：定义回测报告的标准数据结构，并持久化存储。
* **子任务**：
    * 定义回测报告 Schema（权益曲线、交易列表、统计指标）
    * 实现 LEAN 输出结果 → 标准报告格式的转换器
    * 实现回测报告的数据库存储
    * 实现回测历史查询 API（`GET /api/backtest/:id`）
    * 实现回测报告的导出功能（JSON/CSV）
* **验收标准**：回测报告包含完整的权益曲线、逐笔交易、关键统计指标，可持久化查询。

---

## Milestone 3: 前端核心体验 (Frontend Core — MVP 可发布节点)
> 目标：完成策略构建 → 回测 → 查看报告的完整用户闭环，这是 MVP 的核心。

### Task 3.1: 策略拖拽画布 (Visual Strategy Builder)
* **描述**：基于 React Flow 构建可视化策略编辑器，用户通过拖拽节点和连线构建策略逻辑。
* **子任务**：
    * 搭建 React Flow 画布基础框架
    * 开发**数据源节点**（选择品种、时间周期）
    * 开发**指标节点**（MACD、RSI、EMA、Bollinger Bands 等）
    * 开发**条件判断节点**（大于/小于/交叉/穿越等逻辑）
    * 开发**交易动作节点**（买入/卖出/止损/止盈/仓位比例）
    * 开发**风控节点**（最大持仓、单笔亏损限制、每日亏损限制）
    * 实现节点之间的连线验证（类型匹配、循环检测）
    * 实现画布的保存/加载（策略 JSON 序列化）
    * 实现撤销/重做功能
* **验收标准**：用户可通过拖拽构建完整的"双均线交叉"策略并保存。

### Task 3.2: 回测配置面板
* **描述**：用户在策略编辑完成后，通过配置面板设定回测参数并一键启动回测。
* **子任务**：
    * 实现回测时间范围选择器（6个月 / 1年 / 2年 / 5年）
    * 实现初始资金输入
    * 实现杠杆倍数选择
    * 实现手续费模型选择（固定手续费 / 百分比手续费）
    * 实现滑点模型选择
    * "开始回测" 按钮 → 调用回测 API → 展示进度条
* **验收标准**：用户配置参数后点击回测，前端展示实时进度，完成后跳转到报告页。

### Task 3.3: 可视化回测报告仪表盘
* **描述**：开发丰富的交互式回测报告页面，包含关键指标和图表。
* **子任务**：
    * **权益曲线图**（TradingView Lightweight Charts，支持缩放/拖拽）
    * **关键指标卡片**（总收益率、年化收益、Sharpe Ratio、最大回撤、胜率、盈亏比、利润因子）
    * **回撤分布图**（展示历史回撤深度与持续时间）
    * **月度收益热力图**（按月展示盈亏分布）
    * **逐笔交易列表**（时间、方向、价格、盈亏，支持排序/筛选）
    * **交易标注**（在 K线图上标注买卖点）
    * 报告页面的打印/导出功能
* **验收标准**：报告页面完整展示所有指标，图表可交互，数据与回测结果一致。

### Task 3.4: 基础策略模板库
* **描述**：预置 5-8 个经典策略模板，用户可一键加载到画布中学习和修改。
* **子任务**：
    * **双均线交叉策略**（SMA/EMA 金叉死叉）
    * **RSI 超买超卖策略**
    * **布林带突破策略**
    * **MACD 动量策略**
    * **海龟交易法则**（趋势突破）
    * 每个模板附带文字说明（策略原理、适用市场、参数建议）
    * 实现模板一键加载到画布功能
* **验收标准**：用户可浏览模板列表，点击加载到画布，直接运行回测。

### Task 3.5: 用户仪表盘与策略管理
* **描述**：用户登录后的主页面，展示个人策略列表、回测历史、快捷操作。
* **子任务**：
    * 我的策略列表（创建/编辑/复制/删除/版本历史）
    * 回测历史记录列表
    * 策略标签与分类
    * 策略搜索与筛选
    * 策略导入/导出（JSON 格式）
* **验收标准**：用户可管理自己的所有策略和回测记录。

---

## Milestone 4: AI 助手 + Forward Test (智能化 & 实时化)
> 目标：引入 AI 能力和实时模拟盘，提升产品核心竞争力。

### Task 4.1: AI 策略助手 — 自然语言生成策略
* **描述**：接入 LLM API，用户用自然语言描述策略意图，AI 生成对应的策略逻辑 JSON 并加载到画布。
* **子任务**：
    * 设计 Prompt Engineering 框架（针对策略领域的 System Prompt）
    * 接入 LLM API（OpenAI / Claude）+ Vercel AI SDK
    * 实现自然语言 → 策略 JSON 的解析管线
    * 实现对话式策略调整（"把止损改为 2%"、"加一个 RSI 过滤"）
    * 实现 AI 生成结果的画布预览（用户确认后加载）
    * 实现策略意图理解的错误处理与引导提示
* **验收标准**：用户输入"当 BTC 的 RSI 低于 30 时买入，高于 70 时卖出"，AI 正确生成策略并加载到画布。

### Task 4.2: AI 策略诊断与优化
* **描述**：AI 分析回测结果，自动生成诊断报告和优化建议。
* **子任务**：
    * 实现回测结果 → AI 分析 Prompt 的构建
    * 实现 AI 诊断报告生成（识别策略弱点：过拟合、回撤过大、胜率过低等）
    * 实现参数优化建议（"建议将 EMA 周期从 20 调整为 50"）
    * 实现诊断报告的可视化展示
    * 实现"一键应用建议"功能（AI 建议直接修改策略参数）
* **验收标准**：回测完成后用户可点击"AI 诊断"，获得有价值的分析和可操作的优化建议。

### Task 4.3: Forward Test 模拟实盘系统
* **描述**：用户将回测满意的策略部署到实时行情流中运行，监控真实市场中的表现。
* **子任务**：
    * 实现策略 → Forward Test 一键部署功能
    * 实现 Forward Test Worker（连接实时行情，按策略逻辑触发信号）
    * 实现实时仓位与盈亏追踪
    * 实现 Forward Test 仪表盘（实时权益曲线、持仓状态、信号日志）
    * 实现浏览器通知推送（策略触发买卖信号时提醒）
    * 实现 Forward Test 的启停控制与时间限制（如最长运行 30 天）
* **验收标准**：策略可在实时行情中运行，用户可在仪表盘实时查看策略表现。

---

## Milestone 5: 学习中心 + 社区生态 (Academy & Community)
> 目标：构建内容生态与用户社区，提升留存率和产品粘性。

### Task 5.1: 策略学院模块
* **描述**：内置互动教程系统，引导用户从零开始学习策略构建。
* **子任务**：
    * 设计课程结构（入门→进阶→高级，分 3-4 个等级）
    * 开发互动教程组件（步骤引导 + 画布操作提示）
    * 编写入门教程：第一个均线交叉策略
    * 编写进阶教程：多指标组合策略
    * 编写高级教程：风控与仓位管理
    * 实现学习进度追踪
    * 实现课程完成认证（徽章奖励）
* **验收标准**：新用户跟随教程可在 15 分钟内完成第一个策略的创建和回测。

### Task 5.2: 策略勋章与成就系统
* **描述**：游戏化激励机制，用户完成特定成就获得勋章。
* **子任务**：
    * 定义勋章体系（如"首次回测"、"Sharpe > 2.0 黄金逻辑"、"连续 5 个盈利策略"等）
    * 实现勋章判定逻辑
    * 实现勋章展示（个人主页、策略卡片）
    * 实现成就通知推送
* **验收标准**：用户达成条件后自动获得勋章，可在个人主页展示。

### Task 5.3: 策略分享与社区
* **描述**：用户可以发布自己的策略供他人学习和参考。
* **子任务**：
    * 实现策略公开/私有切换
    * 实现策略广场（公开策略浏览/搜索/排序）
    * 实现策略点赞/收藏功能
    * 实现策略评论功能
    * 实现策略一键 Fork（复制他人策略到自己的画布中修改）
* **验收标准**：用户可浏览社区策略，Fork 后进行回测。

---

## 各里程碑优先级与依赖关系

```
Milestone 0 (基础设施)
    ↓
Milestone 1 (数据管线) ← 必须先有数据，后续才能回测
    ↓
Milestone 2 (回测引擎) ← 依赖数据管线提供行情数据
    ↓
Milestone 3 (前端核心) ← 依赖回测引擎提供回测能力  ★ MVP 发布节点
    ↓
Milestone 4 (AI + Forward Test) ← 依赖前端核心和数据管线
    ↓
Milestone 5 (学习 + 社区) ← 可在 MVP 后并行开发
```
